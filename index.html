<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Aplikasi</title>
    <style>
        /* Style for notification */
        #notifikasi {
            display: none;
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            position: fixed;
            bottom: 10px;
            right: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>

<!-- Login Form -->
<div id="login-form">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username" required>
    <input type="password" id="password" placeholder="Password" required>
    <button onclick="login()">Login</button>
</div>

<!-- Notifikasi -->
<div id="notifikasi">Transaksi berhasil!</div>

<!-- Menu Admin, Kasir, Pelanggan -->
<ul>
    <li id="admin-menu" style="display:none;">
        <a href="#">Dashboard Admin</a>
    </li>
    <li id="kasir-menu" style="display:none;">
        <a href="#">Transaksi Kasir</a>
    </li>
    <li id="pelanggan-menu" style="display:none;">
        <a href="#">Belanja Produk</a>
    </li>
</ul>

<!-- Transaksi Form -->
<div id="transaksi-form" style="display:none;">
    <h3>Form Transaksi</h3>
    <label for="produk">Produk</label>
    <input type="text" id="produk" required>
    <label for="jumlah">Jumlah</label>
    <input type="number" id="jumlah" required>
    <label for="diskon">Diskon (%)</label>
    <input type="number" id="diskon">
    <label for="ongkir">Ongkir</label>
    <input type="number" id="ongkir">
    <button onclick="prosesTransaksi()">Proses Transaksi</button>
</div>

<!-- Riwayat Transaksi -->
<div id="riwayat-transaksi" style="display:none;">
    <h3>Riwayat Transaksi</h3>
    <ul id="transaksi-list"></ul>
</div>

<script>
    // IndexedDB Setup
    const dbName = "kasirDB";
    let db;

    const request = indexedDB.open(dbName, 1);

    request.onupgradeneeded = function (e) {
        db = e.target.result;
        if (!db.objectStoreNames.contains("produk")) {
            const produkStore = db.createObjectStore("produk", { keyPath: "id", autoIncrement: true });
            produkStore.createIndex("nama", "nama", { unique: true });
        }
        if (!db.objectStoreNames.contains("transaksi")) {
            const transaksiStore = db.createObjectStore("transaksi", { keyPath: "id", autoIncrement: true });
        }
        if (!db.objectStoreNames.contains("users")) {
            const usersStore = db.createObjectStore("users", { keyPath: "username" });
            usersStore.createIndex("username", "username", { unique: true });
        }
    };

    request.onsuccess = function (e) {
        db = e.target.result;
        // Insert sample data if not present
        checkAndInsertSampleData();
    };

    request.onerror = function (e) {
        console.error("Error opening IndexedDB", e);
    };

    function checkAndInsertSampleData() {
        const transaction = db.transaction(["users"], "readonly");
        const store = transaction.objectStore("users");
        const request = store.get("admin");

        request.onsuccess = function (event) {
            if (!event.target.result) {
                // Insert default user (admin)
                const admin = {
                    username: "admin",
                    password: "admin123",
                    role: "Admin"
                };
                const addRequest = store.add(admin);
                addRequest.onsuccess = function () {
                    console.log("Admin added");
                };
            }
        };
    }

    // Login Function
    function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const transaction = db.transaction(["users"], "readonly");
        const store = transaction.objectStore("users");
        const request = store.get(username);

        request.onsuccess = function (event) {
            const user = event.target.result;
            if (user && user.password === password) {
                localStorage.setItem("role", user.role);
                tampilkanDashboard(user.role);
            } else {
                alert("Username atau password salah");
            }
        };

        request.onerror = function () {
            alert("Gagal login!");
        };
    }

    // Tampilkan Dashboard berdasarkan Role
    function tampilkanDashboard(role) {
        document.getElementById("login-form").style.display = "none";

        if (role === "Admin") {
            document.getElementById("admin-menu").style.display = "block";
            document.getElementById("kasir-menu").style.display = "none";
            document.getElementById("pelanggan-menu").style.display = "none";
        } else if (role === "Kasir") {
            document.getElementById("admin-menu").style.display = "none";
            document.getElementById("kasir-menu").style.display = "block";
            document.getElementById("pelanggan-menu").style.display = "none";
        } else if (role === "Pelanggan") {
            document.getElementById("admin-menu").style.display = "none";
            document.getElementById("kasir-menu").style.display = "none";
            document.getElementById("pelanggan-menu").style.display = "block";
        }
    }

    // Fungsi untuk menampilkan notifikasi
    function tampilkanNotifikasi(message) {
        const notifikasi = document.getElementById("notifikasi");
        notifikasi.innerHTML = message;
        notifikasi.style.display = "block";
        setTimeout(function () {
            notifikasi.style.display = "none";
        }, 3000);
    }

    // Fungsi untuk proses transaksi
    function prosesTransaksi() {
        const produk = document.getElementById("produk").value;
        const jumlah = parseInt(document.getElementById("jumlah").value);
        const diskon = parseInt(document.getElementById("diskon").value) || 0;
        const ongkir = parseInt(document.getElementById("ongkir").value) || 0;

        const total = (jumlah * 1000) * (1 - diskon / 100) + ongkir; // Asumsi harga produk = 1000
        const transaksi = {
            produk,
            jumlah,
            diskon,
            ongkir,
            total,
            status: "Tunggu Pembayaran",
            tanggal: new Date()
        };

        const transaction = db.transaction(["transaksi"], "readwrite");
        const store = transaction.objectStore("transaksi");
        const request = store.add(transaksi);

        request.onsuccess = function () {
            tampilkanNotifikasi("Transaksi berhasil diproses!");
            updateTransaksiList();
        };

        request.onerror = function () {
            alert("Gagal memproses transaksi!");
        };
    }

    // Fungsi untuk update daftar transaksi
    function updateTransaksiList() {
        const transaction = db.transaction(["transaksi"], "readonly");
        const store = transaction.objectStore("transaksi");
        const request = store.getAll();

        request.onsuccess = function (event) {
            const transaksiList = event.target.result;
            const listContainer = document.getElementById("transaksi-list");
            listContainer.innerHTML = "";

            transaksiList.forEach(function (transaksi) {
                const li = document.createElement("li");
                li.innerHTML = `
                    Produk: ${transaksi.produk}<br>
                    Jumlah: ${transaksi.jumlah}<br>
                    Diskon: ${transaksi.diskon}%<br>
                    Ongkir: ${transaksi.ongkir}<br>
                    Total: ${transaksi.total}<br>
                    Status: ${transaksi.status}<br>
                    Tanggal: ${new Date(transaksi.tanggal).toLocaleString()}
                `;
                listContainer.appendChild(li);
            });
        };
    }
</script>

</body>
</html>
